# ============================================================================
# SLSA Provenance Workflow Template
# ============================================================================
# Generates SLSA Level 3 provenance attestations for Python packages
#
# IMPORTANT: This is a TEMPLATE, not a reusable workflow!
# GitHub Actions does not support nested reusable workflow calls.
# You must copy the 'provenance' job directly into your release workflow.
#
# Usage - Copy this job into your workflow:
#   jobs:
#     build:
#       runs-on: ubuntu-latest
#       outputs:
#         hashes: ${{ steps.hash.outputs.hashes }}
#       steps:
#         - uses: actions/checkout@v4
#         - run: pip install build && python -m build
#         - id: hash
#           run: |
#             cd dist && echo "hashes=$(sha256sum * | base64 -w0)" >> "$GITHUB_OUTPUT"
#         - uses: actions/upload-artifact@v4
#           with:
#             name: dist
#             path: dist/
#
#     # Copy this job directly into your workflow
#     provenance:
#       needs: build
#       permissions:
#         actions: read
#         id-token: write
#         contents: write
#       uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
#       with:
#         base64-subjects: ${{ needs.build.outputs.hashes }}
#         upload-assets: true
#         upload-tag-name: ${{ github.ref_name }}
#         provenance-name: multiple.intoto.jsonl
#
# Features:
#   - SLSA Level 3 provenance generation
#   - Supply chain security attestations
#   - Automatic release artifact attachment
#
# Why can't this be a reusable workflow?
#   GitHub Actions doesn't allow reusable workflows to call other reusable
#   workflows. Since SLSA provenance requires calling the official
#   slsa-framework generator (which is itself a reusable workflow),
#   you must call it directly from your workflow.
#
# See: https://docs.github.com/en/actions/using-workflows/reusing-workflows#limitations
# ============================================================================

name: SLSA Provenance (Template)

# This workflow demonstrates SLSA provenance generation
# It can be triggered manually for testing or referenced as a template
on:
  workflow_dispatch:
    inputs:
      base64-subjects:
        description: 'Base64-encoded SHA256 hashes of artifacts (sha256sum * | base64 -w0)'
        type: string
        required: true

      upload-assets:
        description: 'Upload provenance to GitHub Release'
        type: boolean
        required: false
        default: true

      upload-tag-name:
        description: 'Tag name for release upload (defaults to github.ref_name)'
        type: string
        required: false
        default: ''

      provenance-name:
        description: 'Name for the provenance file'
        type: string
        required: false
        default: 'multiple.intoto.jsonl'

permissions:
  actions: read
  id-token: write
  contents: write

jobs:
  provenance:
    name: Generate SLSA Provenance
    # Use the official SLSA generator directly
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: ${{ inputs.base64-subjects }}
      upload-assets: ${{ inputs.upload-assets }}
      upload-tag-name: ${{ inputs.upload-tag-name || github.ref_name }}
      provenance-name: ${{ inputs.provenance-name }}
