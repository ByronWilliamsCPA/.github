# ============================================================================
# Reusable Python CI/CD Workflow
# ============================================================================
# Comprehensive CI with UV, testing, linting, type checking, and LLM governance
#
# Usage from downstream repos:
#   jobs:
#     ci:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-ci.yml@main
#       with:
#         python-version: '3.12'
#         coverage-threshold: 80
#         enable-matrix-testing: true  # Enable tiered testing strategy
#       secrets:
#         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
#
# Features:
#   - Standard quality checks (tests, linting, type checking)
#   - Dead code detection with Vulture (configurable confidence)
#   - LLM governance and assumption tag verification
#   - Optional SonarCloud integration
#   - Optional Codecov integration
#   - Security scanning (Bandit, Safety)
#   - Tiered matrix testing (fast PRs, comprehensive main/schedule)
#
# Tiered Testing Strategy:
#   - PR events: Tests against python-versions-pr (default: ["3.11", "3.12"])
#   - Main/schedule: Tests against python-versions-comprehensive (default: ["3.10", "3.11", "3.12", "3.13"])
#   - Reduces PR CI time by 50% while maintaining comprehensive coverage
# ============================================================================

name: Python CI (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use (primary version for quality checks)'
        required: false
        type: string
        default: '3.12'
      python-versions-pr:
        description: 'Python versions for PR testing (fast feedback)'
        type: string
        required: false
        default: '["3.11", "3.12"]'
      python-versions-comprehensive:
        description: 'Python versions for main/schedule testing (comprehensive)'
        type: string
        required: false
        default: '["3.10", "3.11", "3.12", "3.13"]'
      enable-matrix-testing:
        description: 'Enable multi-version matrix testing (uses tiered strategy)'
        type: boolean
        required: false
        default: false
      coverage-threshold:
        description: 'Minimum code coverage percentage'
        required: false
        type: number
        default: 80
      source-directory:
        description: 'Source code directory'
        required: false
        type: string
        default: 'src'
      test-directory:
        description: 'Test directory'
        required: false
        type: string
        default: 'tests'
      enable-sonarcloud:
        description: 'Enable SonarCloud quality gate'
        required: false
        type: boolean
        default: false
      sonarcloud-organization:
        description: 'SonarCloud organization'
        required: false
        type: string
        default: ''
      sonarcloud-project-key:
        description: 'SonarCloud project key'
        required: false
        type: string
        default: ''
      enable-codecov:
        description: 'Enable Codecov uploads'
        required: false
        type: boolean
        default: false
      run-integration-tests:
        description: 'Run integration tests'
        required: false
        type: boolean
        default: true
      run-security-tests:
        description: 'Run security tests'
        required: false
        type: boolean
        default: true
      fail-on-llm-tags:
        description: 'Fail if LLM debt tags found'
        required: false
        type: boolean
        default: false
      enable-dead-code-check:
        description: 'Enable dead code detection with Vulture'
        required: false
        type: boolean
        default: true
      dead-code-confidence:
        description: 'Minimum confidence for dead code detection (60-100)'
        required: false
        type: number
        default: 80
      fail-on-dead-code:
        description: 'Fail CI if dead code is detected'
        required: false
        type: boolean
        default: false
    secrets:
      SONAR_TOKEN:
        description: 'SonarCloud token'
        required: false
      CODECOV_TOKEN:
        description: 'Codecov token'
        required: false

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ============================================================================
  # Job 0: Check Secret Availability (Required for conditional jobs)
  # ============================================================================
  # NOTE: In reusable workflows, secrets cannot be directly referenced in job-level
  # `if:` conditions. This job detects secret availability and exposes it as an output.
  check-secrets:
    name: Check Secret Availability
    runs-on: ubuntu-latest
    outputs:
      has-sonar-token: ${{ steps.check.outputs.has-sonar-token }}
      has-codecov-token: ${{ steps.check.outputs.has-codecov-token }}
    steps:
      - name: Check for available secrets
        id: check
        run: |
          # Check SONAR_TOKEN availability
          if [ -n "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "has-sonar-token=true" >> $GITHUB_OUTPUT
          else
            echo "has-sonar-token=false" >> $GITHUB_OUTPUT
          fi

          # Check CODECOV_TOKEN availability
          if [ -n "${{ secrets.CODECOV_TOKEN }}" ]; then
            echo "has-codecov-token=true" >> $GITHUB_OUTPUT
          else
            echo "has-codecov-token=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Job 1: Standard Quality Checks
  # ============================================================================
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      coverage-artifact: coverage-reports

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a  # v5.1.0
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run Ruff formatter check
        run: |
          echo "::group::Ruff Formatting"
          uv run ruff format --check ${{ inputs.source-directory }}/ ${{ inputs.test-directory }}/ || {
            echo "::error::Code formatting issues detected. Run 'uv run ruff format ${{ inputs.source-directory }}/ ${{ inputs.test-directory }}/' to fix."
            exit 1
          }
          echo "::endgroup::"

      - name: Run Ruff linter
        run: |
          echo "::group::Ruff Linting"
          uv run ruff check ${{ inputs.source-directory }}/ ${{ inputs.test-directory }}/ --output-format=github
          echo "::endgroup::"

      - name: Run BasedPyright type checker
        run: |
          echo "::group::BasedPyright Type Checking"
          uv run basedpyright ${{ inputs.source-directory }}/ || {
            echo "::warning::Type checking found issues"
          }
          echo "::endgroup::"

      - name: Dead code detection with Vulture
        if: inputs.enable-dead-code-check
        run: |
          echo "::group::Vulture Dead Code Detection"

          # Install vulture if not in dev dependencies
          uv pip install vulture 2>/dev/null || true

          # Run vulture with configurable confidence threshold
          echo "Scanning for dead code (min confidence: ${{ inputs.dead-code-confidence }}%)..."

          # Capture output for reporting
          VULTURE_OUTPUT=$(uv run vulture ${{ inputs.source-directory }}/ --min-confidence ${{ inputs.dead-code-confidence }} 2>&1) || true

          if [ -n "$VULTURE_OUTPUT" ]; then
            echo "$VULTURE_OUTPUT"

            # Count issues
            DEAD_CODE_COUNT=$(echo "$VULTURE_OUTPUT" | grep -c ":" || echo "0")

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Dead Code Detection (Vulture)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Found $DEAD_CODE_COUNT potential dead code issue(s)** (confidence ≥${{ inputs.dead-code-confidence }}%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$VULTURE_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** Review these findings. Some may be false positives (e.g., pytest fixtures, CLI entry points)." >> $GITHUB_STEP_SUMMARY
            echo "> Use a `.vulture_whitelist.py` file to suppress known false positives." >> $GITHUB_STEP_SUMMARY

            if [ "${{ inputs.fail-on-dead-code }}" == "true" ]; then
              echo "::error::Dead code detected. Set 'fail-on-dead-code: false' to make this a warning."
              exit 1
            else
              echo "::warning::Potential dead code detected. Review vulture output above."
            fi
          else
            echo "No dead code detected at ${{ inputs.dead-code-confidence }}% confidence threshold."
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Dead Code Detection (Vulture)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ No dead code detected (confidence ≥${{ inputs.dead-code-confidence }}%)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "::endgroup::"

      - name: Run unit tests with coverage
        run: |
          echo "::group::Unit Test Execution"
          uv run pytest \
            -m "unit or not (integration or security or slow)" \
            --cov=${{ inputs.source-directory }} \
            --cov-report=xml:coverage-unit.xml \
            --cov-report=term-missing \
            --cov-branch \
            -v
          echo "::endgroup::"

      - name: Run integration tests with coverage
        if: inputs.run-integration-tests
        run: |
          echo "::group::Integration Test Execution"
          uv run pytest \
            -m "integration" \
            --cov=${{ inputs.source-directory }} \
            --cov-report=xml:coverage-integration.xml \
            --cov-report=term-missing \
            --cov-branch \
            --cov-append \
            -v || echo "No integration tests found or all skipped"
          echo "::endgroup::"

      - name: Run security tests with coverage
        if: inputs.run-security-tests
        run: |
          echo "::group::Security Test Execution"
          uv run pytest \
            -m "security" \
            --cov=${{ inputs.source-directory }} \
            --cov-report=xml:coverage-security.xml \
            --cov-report=term-missing \
            --cov-branch \
            --cov-append \
            -v || echo "No security tests found or all skipped"
          echo "::endgroup::"

      - name: Generate combined coverage report
        run: |
          echo "::group::Combined Coverage"
          uv run coverage combine --keep || true
          uv run coverage xml -o coverage.xml
          uv run coverage html
          uv run coverage report --fail-under=${{ inputs.coverage-threshold }}
          echo "::endgroup::"

      - name: Security scan with Bandit
        run: |
          echo "::group::Bandit Security Scan"
          uv run bandit -r ${{ inputs.source-directory }}/ -f json -o bandit-report.json || {
            echo "::warning::Security issues detected"
            cat bandit-report.json
          }
          echo "::endgroup::"

      - name: Dependency vulnerability scan
        run: |
          echo "::group::Safety Dependency Scan"
          # Export requirements and scan
          uv pip compile pyproject.toml -o requirements.txt
          uv run safety check -r requirements.txt || {
            echo "::warning::Vulnerable dependencies detected"
          }
          echo "::endgroup::"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: coverage-reports
          path: |
            coverage.xml
            coverage-*.xml
            htmlcov/
          retention-days: 7

      - name: Upload coverage to Codecov
        if: inputs.enable-codecov
        uses: codecov/codecov-action@af2c6347526edfe5ff45ad690affad475d77ddb4  # v5.3.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: ${{ github.repository }}
          file: ./coverage.xml
          flags: python-${{ inputs.python-version }}
          name: combined-coverage
          fail_ci_if_error: false

  # ============================================================================
  # Job 2: LLM Governance Checks
  # ============================================================================
  llm-governance:
    name: LLM Governance & Assumption Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      rad-tags: ${{ steps.check-tags.outputs.rad_tags }}
      llm-tags: ${{ steps.check-tags.outputs.llm_tags }}
      total-tags: ${{ steps.check-tags.outputs.total_tags }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Check for unverified assumption tags
        id: check-tags
        run: |
          echo "::group::Scanning for Unverified Assumption Tags"

          # Check for RAD tags (Layer 1: Production Runtime Risks)
          CRITICAL_TAGS=$(grep -r "#CRITICAL" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          ASSUME_TAGS=$(grep -r "#ASSUME" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          EDGE_TAGS=$(grep -r "#EDGE" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")

          # Check for LLM debt tags (Layer 2: LLM Development Debt)
          LLM_MOCK=$(grep -r "#LLM-MOCK" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          LLM_PLACEHOLDER=$(grep -r "#LLM-PLACEHOLDER" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          LLM_LOGIC=$(grep -r "#LLM-LOGIC" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          LLM_SCAFFOLD=$(grep -r "#LLM-SCAFFOLD" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          LLM_INFERRED=$(grep -r "#LLM-INFERRED" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")
          LLM_TEST_FIRST=$(grep -r "#LLM-TEST-FIRST" --include="*.py" ${{ inputs.source-directory }}/ 2>/dev/null | wc -l || echo "0")

          TOTAL_RAD=$((CRITICAL_TAGS + ASSUME_TAGS))
          TOTAL_LLM=$((LLM_MOCK + LLM_PLACEHOLDER + LLM_LOGIC + LLM_SCAFFOLD + LLM_INFERRED + LLM_TEST_FIRST))
          TOTAL_TAGS=$((TOTAL_RAD + TOTAL_LLM))

          echo "rad_tags=$TOTAL_RAD" >> $GITHUB_OUTPUT
          echo "llm_tags=$TOTAL_LLM" >> $GITHUB_OUTPUT
          echo "total_tags=$TOTAL_TAGS" >> $GITHUB_OUTPUT

          echo "### Assumption Tag Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer 1 (Production Runtime Risks):**" >> $GITHUB_STEP_SUMMARY
          echo "- #CRITICAL tags: $CRITICAL_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "- #ASSUME tags: $ASSUME_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "- #EDGE tags: $EDGE_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer 2 (LLM Development Debt):**" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-MOCK: $LLM_MOCK" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-PLACEHOLDER: $LLM_PLACEHOLDER" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-LOGIC: $LLM_LOGIC" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-SCAFFOLD: $LLM_SCAFFOLD" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-INFERRED: $LLM_INFERRED" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-TEST-FIRST: $LLM_TEST_FIRST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total unverified tags: $TOTAL_TAGS**" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL_RAD" -gt 0 ]; then
            echo "::error::Found $TOTAL_RAD unverified production risk tags (#CRITICAL, #ASSUME)"
          fi

          if [ "$TOTAL_LLM" -gt 0 ]; then
            echo "::warning::Found $TOTAL_LLM unverified LLM debt tags"
          fi

          echo "::endgroup::"

      - name: Block PR if critical tags found
        if: ${{ fromJSON(steps.check-tags.outputs.rad_tags) > 0 }}
        run: |
          echo "::error::PR blocked: Found ${{ steps.check-tags.outputs.rad_tags }} unverified production risk tags"
          echo ""
          echo "Please verify and remove these tags before merging:"
          grep -rn "#CRITICAL\|#ASSUME" --include="*.py" ${{ inputs.source-directory }}/ || true
          echo ""
          echo "See CLAUDE.md for verification workflow"
          exit 1

      - name: Fail on LLM tags (if configured)
        if: ${{ inputs.fail-on-llm-tags && fromJSON(steps.check-tags.outputs.llm_tags) > 0 }}
        run: |
          echo "::error::PR blocked: Found ${{ steps.check-tags.outputs.llm_tags }} LLM debt tags"
          echo ""
          echo "Please address LLM debt before merging:"
          grep -rn "#LLM-" --include="*.py" ${{ inputs.source-directory }}/ || true
          exit 1

      - name: Detect LLM anti-patterns
        run: |
          echo "::group::LLM Anti-Pattern Detection"

          # Hardcoded localhost/URLs
          echo "Checking for hardcoded localhost/URLs..."
          if grep -rE "(localhost|127\.0\.0\.1|http://|https://)" --include="*.py" ${{ inputs.source-directory }}/ | \
             grep -v "#LLM-PLACEHOLDER" | grep -v "^[[:space:]]*#"; then
            echo "::warning::Found hardcoded URLs without #LLM-PLACEHOLDER tag"
          fi

          # Hardcoded secrets patterns
          echo "Checking for potential hardcoded secrets..."
          if grep -rE "(api_key|password|secret|token)\s*=\s*[\"'][^\"']+[\"']" --include="*.py" ${{ inputs.source-directory }}/ | \
             grep -v "#LLM-PLACEHOLDER" | grep -v "^[[:space:]]*#"; then
            echo "::error::Potential hardcoded secret detected"
            exit 1
          fi

          # Magic numbers
          echo "Checking for magic numbers..."
          MAGIC_NUMBERS=$(grep -rE "\b[0-9]{2,}\b" --include="*.py" ${{ inputs.source-directory }}/ | \
                          grep -v "#LLM-PLACEHOLDER" | \
                          grep -v "^[[:space:]]*#" | \
                          wc -l || echo "0")

          if [ "$MAGIC_NUMBERS" -gt 10 ]; then
            echo "::warning::Found $MAGIC_NUMBERS potential magic numbers without constants"
          fi

          echo "::endgroup::"

  # ============================================================================
  # Job 3: SonarCloud Quality Gate (Optional)
  # ============================================================================
  sonarcloud-quality-gate:
    name: SonarCloud Quality Gate
    runs-on: ubuntu-latest
    needs: [check-secrets, quality-checks]
    if: inputs.enable-sonarcloud && needs.check-secrets.outputs.has-sonar-token == 'true'
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Download coverage reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: coverage-reports

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@0303d6b62e310685c0e34d0b9cde218036885c4d  # v5.0.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ inputs.sonarcloud-organization }}
            -Dsonar.projectKey=${{ inputs.sonarcloud-project-key }}

      - name: Wait for Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b  # v1.2.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        id: quality-gate

      - name: Quality Gate Result
        run: |
          echo "::group::Quality Gate Status"
          echo "Quality Gate Status: ${{ steps.quality-gate.outputs.quality-gate-status }}"
          echo "View detailed results: https://sonarcloud.io/project/overview?id=${{ inputs.sonarcloud-project-key }}"
          echo "::endgroup::"

      - name: Block PR if quality gate fails
        if: steps.quality-gate.outputs.quality-gate-status == 'FAILED'
        run: |
          echo "::error::Quality Gate FAILED"
          echo ""
          echo "SonarQube quality gate did not pass. Please fix the issues:"
          echo "- Review issues at: https://sonarcloud.io/project/overview?id=${{ inputs.sonarcloud-project-key }}"
          echo "- Fix all BLOCKER and CRITICAL issues"
          echo "- Ensure test coverage >= ${{ inputs.coverage-threshold }}%"
          echo "- Reduce code duplication"
          exit 1

  # ============================================================================
  # Job 4: Tiered Matrix Testing (Optional)
  # ============================================================================
  matrix-testing:
    name: Matrix Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    if: inputs.enable-matrix-testing
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ github.event_name == 'pull_request' && fromJSON(inputs.python-versions-pr) || fromJSON(inputs.python-versions-comprehensive) }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a  # v5.1.0
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: |
          echo "::group::Testing on Python ${{ matrix.python-version }}"
          uv run pytest \
            --cov=${{ inputs.source-directory }} \
            --cov-report=term-missing \
            -v
          echo "::endgroup::"

  # ============================================================================
  # Summary Job
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality-checks, llm-governance, matrix-testing]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "### CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All governance layers checked:" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality Checks: ${{ needs.quality-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- LLM Governance Validation: ${{ needs.llm-governance.result }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.enable-sonarcloud }}" == "true" ]; then
            echo "- SonarCloud Quality Gate: enabled" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.enable-matrix-testing }}" == "true" ]; then
            echo "- Matrix Testing: ${{ needs.matrix-testing.result }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "  - Strategy: Fast PR testing (Python ${{ inputs.python-versions-pr }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - Strategy: Comprehensive testing (Python ${{ inputs.python-versions-comprehensive }})" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status: ${{ job.status }}**" >> $GITHUB_STEP_SUMMARY
