# Python Documentation - Reusable Workflow
# Builds MkDocs documentation with validation and optional GitHub Pages deployment
#
# Usage from downstream repos:
#   jobs:
#     docs:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-docs.yml@main
#       with:
#         deploy-to-pages: true
#       permissions:
#         contents: read
#         pages: write
#         id-token: write

name: Python Documentation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for building docs'
        type: string
        required: false
        default: '3.12'

      docs-directory:
        description: 'Documentation source directory'
        type: string
        required: false
        default: 'docs'

      source-directory:
        description: 'Source code directory for docstring extraction'
        type: string
        required: false
        default: 'src'

      deploy-to-pages:
        description: 'Deploy to GitHub Pages (main branch only)'
        type: boolean
        required: false
        default: false

      docstring-threshold:
        description: 'Minimum docstring coverage percentage'
        type: number
        required: false
        default: 80

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0  # Full history for git-based dates

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a  # v5.1.0
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Cache dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57  # v4.2.0
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/uv.lock') }}-docs

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Check docstring coverage
        run: |
          echo "üìù Checking docstring coverage..."
          uv run interrogate ${{ inputs.source-directory }} \
            --fail-under=${{ inputs.docstring-threshold }} \
            --verbose || echo "‚ö†Ô∏è  Docstring coverage below threshold"

      - name: Build MkDocs site
        run: |
          echo "üèóÔ∏è  Building documentation site..."
          uv run mkdocs build --strict --verbose

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: documentation-site
          path: site/
          retention-days: 7

  deploy:
    name: Deploy to GitHub Pages
    if: ${{ inputs.deploy-to-pages && github.ref == 'refs/heads/main' }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: documentation-site
          path: site/

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b  # v5.0.0

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa  # v3
        with:
          path: site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4
