# ============================================================================
# Reusable ClusterFuzzLite Workflow
# ============================================================================
# Automated fuzzing for Python projects using Google's ClusterFuzzLite
#
# Usage from downstream repos:
#   jobs:
#     fuzzing:
#       uses: williaby/.github/.github/workflows/python-fuzzing.yml@main
#       with:
#         fuzz-seconds: 1200
#         sanitizer: 'address'
#         upload-sarif: true
#
# ClusterFuzzLite provides:
#   - Continuous fuzzing for security vulnerabilities
#   - Integration with GitHub Security tab (SARIF)
#   - Crash artifact collection and retention
#   - Customizable fuzzing duration and sanitizers
#   - Support for Atheris (Python fuzzing engine)
#
# Supported Sanitizers:
#   - address: Memory safety issues (use-after-free, buffer overflow)
#   - undefined: Undefined behavior detection
#   - memory: MemorySanitizer for uninitialized reads (Linux only)
#
# Cost Optimization:
#   - Schedule weekly runs instead of per-PR to reduce CI costs
#   - Use workflow_dispatch for manual testing on security-critical PRs
#   - Adjust fuzz-seconds based on project complexity
# ============================================================================

name: Python Fuzzing (Reusable)

on:
  workflow_call:
    inputs:
      fuzz-seconds:
        description: 'Duration to run fuzzers (in seconds)'
        type: number
        required: false
        default: 600

      sanitizer:
        description: 'Sanitizer to use (address, undefined, memory)'
        type: string
        required: false
        default: 'address'

      upload-sarif:
        description: 'Upload SARIF results to GitHub Security'
        type: boolean
        required: false
        default: true

      crash-retention-days:
        description: 'Days to retain crash artifacts'
        type: number
        required: false
        default: 14

      python-version:
        description: 'Python version for fuzzing'
        type: string
        required: false
        default: '3.12'

      dry-run:
        description: 'Perform dry run (build only, no fuzzing)'
        type: boolean
        required: false
        default: false

      fuzz-target-directory:
        description: 'Directory containing fuzzing targets (default: auto-detect)'
        type: string
        required: false
        default: ''

      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        required: false
        default: 30

      fail-on-crash:
        description: 'Fail workflow if crashes are found'
        type: boolean
        required: false
        default: true

      enable-corpus-prune:
        description: 'Enable corpus pruning to minimize test cases'
        type: boolean
        required: false
        default: false

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  fuzzing:
    name: Build & Run Fuzzers
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Detect Fuzzing Configuration
        id: detect
        run: |
          echo "üîç Detecting fuzzing configuration..."

          # Check for standard fuzz directories
          if [ -d "fuzz" ]; then
            echo "fuzz_dir=fuzz" >> $GITHUB_OUTPUT
            echo "‚úÖ Found fuzzing targets in: fuzz/"
          elif [ -d "tests/fuzz" ]; then
            echo "fuzz_dir=tests/fuzz" >> $GITHUB_OUTPUT
            echo "‚úÖ Found fuzzing targets in: tests/fuzz/"
          elif [ -d "fuzzing" ]; then
            echo "fuzz_dir=fuzzing" >> $GITHUB_OUTPUT
            echo "‚úÖ Found fuzzing targets in: fuzzing/"
          elif [ -n "${{ inputs.fuzz-target-directory }}" ]; then
            echo "fuzz_dir=${{ inputs.fuzz-target-directory }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Using custom fuzzing directory: ${{ inputs.fuzz-target-directory }}"
          else
            echo "‚ö†Ô∏è  No fuzzing directory found"
            echo "   Expected: fuzz/, tests/fuzz/, or fuzzing/"
            echo "   Or specify via 'fuzz-target-directory' input"
            echo "fuzz_dir=" >> $GITHUB_OUTPUT
          fi

          # Check for fuzzing harnesses
          FUZZ_FILES=$(find . -name "fuzz_*.py" -o -name "*_fuzz.py" 2>/dev/null | wc -l)
          echo "fuzzer_count=$FUZZ_FILES" >> $GITHUB_OUTPUT
          echo "üìä Detected $FUZZ_FILES fuzzing harness(es)"

      - name: Validate Fuzzing Setup
        run: |
          if [ "${{ steps.detect.outputs.fuzz_dir }}" == "" ]; then
            echo "‚ùå ERROR: No fuzzing directory found"
            echo ""
            echo "To use this workflow, create one of:"
            echo "  - fuzz/          (recommended)"
            echo "  - tests/fuzz/"
            echo "  - fuzzing/"
            echo ""
            echo "Or specify custom path via 'fuzz-target-directory' input"
            exit 1
          fi

          if [ "${{ steps.detect.outputs.fuzzer_count }}" == "0" ]; then
            echo "‚ö†Ô∏è  WARNING: No fuzzing harnesses detected"
            echo "   Expected files matching: fuzz_*.py or *_fuzz.py"
          fi

      - name: Build Fuzzers
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@82652fb49e77bc29c35da1167bb286e93c6bcc05  # v1
        with:
          language: python
          dry-run: ${{ inputs.dry-run }}

      - name: Run Fuzzers
        if: steps.build.outcome == 'success' && !inputs.dry-run
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@82652fb49e77bc29c35da1167bb286e93c6bcc05  # v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: ${{ inputs.fuzz-seconds }}
          language: python
          output-sarif: ${{ inputs.upload-sarif }}
          sanitizer: ${{ inputs.sanitizer }}

      - name: Prune Corpus
        if: inputs.enable-corpus-prune && steps.build.outcome == 'success'
        run: |
          echo "üßπ Pruning corpus to minimize test cases..."
          # ClusterFuzzLite doesn't have a standalone prune action
          # Implement basic corpus minimization using libFuzzer's -merge feature
          if [ -d "out/corpus" ]; then
            CORPUS_COUNT=$(find out/corpus -type f | wc -l)
            echo "üìä Current corpus size: $CORPUS_COUNT files"

            # Create minimized corpus directory
            mkdir -p out/corpus-minimized

            # Use libFuzzer merge to deduplicate and minimize
            # This removes redundant test cases that don't increase coverage
            for fuzzer in out/fuzzers/*; do
              if [ -x "$fuzzer" ]; then
                FUZZER_NAME=$(basename "$fuzzer")
                CORPUS_DIR="out/corpus/$FUZZER_NAME"
                if [ -d "$CORPUS_DIR" ]; then
                  echo "  Pruning corpus for $FUZZER_NAME..."
                  mkdir -p "out/corpus-minimized/$FUZZER_NAME"
                  "$fuzzer" -merge=1 "out/corpus-minimized/$FUZZER_NAME" "$CORPUS_DIR" 2>/dev/null || true
                fi
              fi
            done

            MINIMIZED_COUNT=$(find out/corpus-minimized -type f 2>/dev/null | wc -l)
            echo "üìä Minimized corpus size: $MINIMIZED_COUNT files"

            if [ "$MINIMIZED_COUNT" -gt 0 ]; then
              # Replace original corpus with minimized version
              rm -rf out/corpus
              mv out/corpus-minimized out/corpus
              echo "‚úÖ Corpus pruned successfully"
            else
              echo "‚ö†Ô∏è  Corpus minimization produced no output, keeping original"
              rm -rf out/corpus-minimized
            fi
          else
            echo "‚ÑπÔ∏è  No corpus directory found, skipping prune"
          fi

      - name: Check for Crashes
        if: always() && steps.build.outcome == 'success' && !inputs.dry-run
        id: check_crashes
        run: |
          if [ -d "out/artifacts" ] && [ "$(ls -A out/artifacts 2>/dev/null)" ]; then
            echo "crash_found=true" >> $GITHUB_OUTPUT
            echo "‚ùå Crashes detected! See artifacts for details."

            # List crash files
            echo ""
            echo "üìã Crash artifacts:"
            find out/artifacts -type f -exec basename {} \; | sort

            if [ "${{ inputs.fail-on-crash }}" == "true" ]; then
              exit 1
            fi
          else
            echo "crash_found=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No crashes detected during fuzzing"
          fi

      - name: Upload Crash Artifacts
        if: always() && steps.check_crashes.outputs.crash_found == 'true'
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: fuzzing-crashes-${{ github.run_id }}-${{ inputs.sanitizer }}
          path: out/artifacts
          retention-days: ${{ inputs.crash-retention-days }}

      - name: Upload SARIF Report
        if: inputs.upload-sarif && always() && steps.build.outcome == 'success'
        uses: github/codeql-action/upload-sarif@8ff85221d12737ec1137e6a892722e5130f32d05  # v3.28.8
        with:
          sarif_file: sarif/cifuzz.sarif
        continue-on-error: true

      - name: Fuzzing Summary
        if: always()
        run: |
          echo "# üîç ClusterFuzzLite Fuzzing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fuzzing Duration | ${{ inputs.fuzz-seconds }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Sanitizer | ${{ inputs.sanitizer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | ${{ inputs.python-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fuzzer Count | ${{ steps.detect.outputs.fuzzer_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Crashes Found | ${{ steps.check_crashes.outputs.crash_found || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "## ‚úÖ Fuzzing Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Fuzzers executed for ${{ inputs.fuzz-seconds }} seconds" >> $GITHUB_STEP_SUMMARY
            echo "- Sanitizer: ${{ inputs.sanitizer }}" >> $GITHUB_STEP_SUMMARY
            echo "- Security analysis: Active" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check_crashes.outputs.crash_found }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚ö†Ô∏è Crashes Detected" >> $GITHUB_STEP_SUMMARY
              echo "Review crash artifacts for details and remediation." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚úÖ No Crashes Detected" >> $GITHUB_STEP_SUMMARY
              echo "All fuzzing targets executed without crashes." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ùå Fuzzer Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Ensure Clang and LLVM are installed" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify fuzzing harnesses exist in ${{ steps.detect.outputs.fuzz_dir }}" >> $GITHUB_STEP_SUMMARY
            echo "3. Check Atheris installation in dependencies" >> $GITHUB_STEP_SUMMARY
            echo "4. Review build logs above for specific errors" >> $GITHUB_STEP_SUMMARY
          fi

          # Also print to console
          echo ""
          echo "üîç ClusterFuzzLite Fuzzing Analysis Complete"
          echo "Build Status: ${{ steps.build.outcome }}"
          echo "Fuzzer Count: ${{ steps.detect.outputs.fuzzer_count }}"
          echo "Duration: ${{ inputs.fuzz-seconds }}s"
          echo "Sanitizer: ${{ inputs.sanitizer }}"

          if [ "${{ steps.check_crashes.outputs.crash_found }}" == "true" ]; then
            echo "‚ö†Ô∏è  Crashes detected - review artifacts"
          else
            echo "‚úÖ No crashes detected"
          fi
