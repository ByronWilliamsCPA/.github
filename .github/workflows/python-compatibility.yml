# ============================================================================
# Reusable Python Compatibility Matrix Workflow
# ============================================================================
# Matrix testing across Python versions and operating systems
#
# Usage from downstream repos:
#   jobs:
#     compatibility:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-compatibility.yml@main
#       with:
#         python-versions: '["3.10", "3.11", "3.12", "3.13"]'
#         operating-systems: '["ubuntu-latest", "macos-latest", "windows-latest"]'
#         skip-on-draft: true  # Skip matrix on draft PRs (92% cost reduction)
#
# Features:
#   - Matrix testing across multiple Python versions
#   - Cross-platform testing (Linux, macOS, Windows)
#   - System dependency installation (apt, brew, choco)
#   - Configurable test commands
#   - Artifact collection per matrix combination
#   - Draft PR awareness (skips expensive matrix during development)
#
# Cost Optimization:
#   - Draft PRs: Skips matrix testing by default (92% reduction)
#   - Ready PRs: Runs full matrix for comprehensive validation
#   - Override: Set skip-on-draft: false to force matrix on drafts
#
# System Dependencies Example (for packages like python-magic):
#   jobs:
#     compatibility:
#       uses: ByronWilliamsCPA/.github/.github/workflows/python-compatibility.yml@main
#       with:
#         system-deps-macos: 'libmagic'
#         system-deps-ubuntu: 'libmagic-dev'
#         system-deps-windows: 'file'
#         include-macos: true
#         include-windows: true
# ============================================================================

name: Python Compatibility (Reusable)

on:
  workflow_call:
    inputs:
      python-versions:
        description: 'JSON array of Python versions to test'
        type: string
        required: false
        default: '["3.10", "3.11", "3.12", "3.13"]'

      operating-systems:
        description: 'JSON array of operating systems to test'
        type: string
        required: false
        default: '["ubuntu-latest"]'

      include-windows:
        description: 'Include Windows in the matrix'
        type: boolean
        required: false
        default: false

      include-macos:
        description: 'Include macOS in the matrix'
        type: boolean
        required: false
        default: false

      source-directory:
        description: 'Source code directory'
        type: string
        required: false
        default: 'src'

      test-command:
        description: 'Test command to run (uses uv run prefix)'
        type: string
        required: false
        default: 'pytest -v'

      coverage-report:
        description: 'Generate coverage reports'
        type: boolean
        required: false
        default: true

      fail-fast:
        description: 'Fail immediately on first matrix failure'
        type: boolean
        required: false
        default: false

      skip-on-draft:
        description: 'Skip expensive matrix on draft PRs (reduces cost by 92%)'
        type: boolean
        required: false
        default: true

      timeout-minutes:
        description: 'Timeout for each matrix job'
        type: number
        required: false
        default: 30

      system-deps-ubuntu:
        description: 'APT packages to install on Ubuntu (space-separated, e.g., "libmagic-dev libffi-dev")'
        type: string
        required: false
        default: ''

      system-deps-macos:
        description: 'Homebrew packages to install on macOS (space-separated, e.g., "libmagic")'
        type: string
        required: false
        default: ''

      system-deps-windows:
        description: 'Chocolatey packages to install on Windows (space-separated)'
        type: string
        required: false
        default: ''

    outputs:
      matrix-result:
        description: 'Overall matrix test result'
        value: ${{ jobs.compatibility-summary.outputs.result }}

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Build dynamic matrix based on inputs
  build-matrix:
    name: Build Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Build matrix configuration
        id: set-matrix
        run: |
          # Start with the provided operating systems
          OS_LIST='${{ inputs.operating-systems }}'

          # Add additional platforms if requested
          if [ "${{ inputs.include-windows }}" == "true" ]; then
            OS_LIST=$(echo "$OS_LIST" | jq '. + ["windows-latest"] | unique')
          fi

          if [ "${{ inputs.include-macos }}" == "true" ]; then
            OS_LIST=$(echo "$OS_LIST" | jq '. + ["macos-latest"] | unique')
          fi

          # Build the full matrix (use -c for compact single-line JSON)
          MATRIX=$(jq -c -n \
            --argjson python '${{ inputs.python-versions }}' \
            --argjson os "$OS_LIST" \
            '{python: $python, os: $os}')

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix: $MATRIX"

  test-matrix:
    name: Test (Python ${{ matrix.python }}, ${{ matrix.os }})
    needs: build-matrix
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    # Skip expensive matrix on draft PRs unless explicitly disabled
    if: ${{ !(inputs.skip-on-draft && github.event.pull_request.draft) }}

    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: ${{ matrix.python }}

      - name: Install UV
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a  # v5.1.0
        with:
          enable-cache: true

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux' && inputs.system-deps-ubuntu != ''
        run: |
          echo "ðŸ“¦ Installing system dependencies: ${{ inputs.system-deps-ubuntu }}"
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.system-deps-ubuntu }}

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS' && inputs.system-deps-macos != ''
        run: |
          echo "ðŸ“¦ Installing system dependencies: ${{ inputs.system-deps-macos }}"
          brew install ${{ inputs.system-deps-macos }}

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows' && inputs.system-deps-windows != ''
        run: |
          echo "ðŸ“¦ Installing system dependencies: ${{ inputs.system-deps-windows }}"
          choco install ${{ inputs.system-deps-windows }} -y
        shell: pwsh

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        id: tests
        run: |
          echo "Running tests on Python ${{ matrix.python }} (${{ matrix.os }})..."

          if [ "${{ inputs.coverage-report }}" == "true" ]; then
            uv run ${{ inputs.test-command }} \
              --cov=${{ inputs.source-directory }} \
              --cov-report=xml:coverage-${{ matrix.python }}-${{ matrix.os }}.xml \
              --cov-report=term-missing
          else
            uv run ${{ inputs.test-command }}
          fi
        shell: bash

      - name: Upload coverage artifact
        if: ${{ inputs.coverage-report && always() }}
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: coverage-${{ matrix.python }}-${{ matrix.os }}
          path: coverage-*.xml
          retention-days: 7

  # Summary job
  compatibility-summary:
    name: Compatibility Summary
    needs: [build-matrix, test-matrix]
    runs-on: ubuntu-latest
    if: always()
    outputs:
      result: ${{ steps.result.outputs.result }}

    steps:
      - name: Set result output
        id: result
        run: echo "result=${{ needs.test-matrix.result }}" >> $GITHUB_OUTPUT

      - name: Generate compatibility matrix summary
        run: |
          echo "## Python Compatibility Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if matrix was skipped due to draft PR
          if [ "${{ inputs.skip-on-draft }}" == "true" ] && [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "### Draft PR Mode" >> $GITHUB_STEP_SUMMARY
            echo "Matrix testing skipped to reduce costs during development." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Skipped (92% cost reduction)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Mark this PR as 'Ready for review' to run full compatibility matrix" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          MATRIX='${{ needs.build-matrix.outputs.matrix }}'
          PYTHON_VERSIONS=$(echo "$MATRIX" | jq -r '.python | join(", ")')
          OS_LIST=$(echo "$MATRIX" | jq -r '.os | join(", ")')

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Versions:** $PYTHON_VERSIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **Operating Systems:** $OS_LIST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-matrix.result }}" == "success" ]; then
            echo "**Status:** All matrix combinations passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-matrix.result }}" == "failure" ]; then
            echo "**Status:** Some matrix combinations failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ${{ needs.test-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check matrix result
        if: ${{ needs.test-matrix.result == 'failure' }}
        run: |
          echo "::error::Compatibility matrix tests failed"
          exit 1
