# ============================================================================
# Reusable Qlty Coverage Upload Workflow
# ============================================================================
# Automated coverage upload to Qlty Cloud for centralized quality tracking
#
# Usage from downstream repos:
#   jobs:
#     qlty-coverage:
#       needs: [ci]  # Run after CI workflow completes
#       if: success()
#       uses: williaby/.github/.github/workflows/python-qlty-coverage.yml@main
#       secrets:
#         QLTY_COVERAGE_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN }}
#       with:
#         coverage-artifact-name: 'test-results-3.12'
#         coverage-file-path: 'reports/lcov.info'
#
# Qlty Cloud Features:
#   - Centralized coverage tracking across repositories
#   - Coverage trend analysis over time
#   - PR coverage diff reporting
#   - Multi-format coverage support (LCOV, Cobertura, JaCoCo, etc.)
#   - Integration with GitHub Security tab
#
# Setup:
#   1. Sign up at https://qlty.sh
#   2. Connect your GitHub organization
#   3. Generate coverage token at https://qlty.sh/settings/tokens
#   4. Add QLTY_COVERAGE_TOKEN to repository secrets
#
# Trigger Patterns:
#   - workflow_run: After CI workflow completes (recommended)
#   - Direct call: From CI workflow as final step
# ============================================================================

name: Qlty Coverage Upload (Reusable)

on:
  workflow_call:
    inputs:
      coverage-artifact-name:
        description: 'Name of artifact containing coverage report'
        type: string
        required: false
        default: 'test-results'

      coverage-file-path:
        description: 'Path to coverage file within artifact (e.g., reports/lcov.info)'
        type: string
        required: false
        default: 'reports/lcov.info'

      coverage-format:
        description: 'Coverage format (lcov, cobertura, jacoco, clover, auto)'
        type: string
        required: false
        default: 'auto'

      python-version:
        description: 'Python version (if needed for post-processing)'
        type: string
        required: false
        default: '3.12'

      workflow-run-id:
        description: 'Workflow run ID to download artifacts from (for workflow_run trigger)'
        type: string
        required: false
        default: ''

      fail-on-upload-error:
        description: 'Fail workflow if coverage upload fails'
        type: boolean
        required: false
        default: false

      skip-if-no-token:
        description: 'Skip upload gracefully if QLTY_COVERAGE_TOKEN not configured'
        type: boolean
        required: false
        default: true

      additional-files:
        description: 'Additional coverage files (comma-separated paths)'
        type: string
        required: false
        default: ''

      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        required: false
        default: 10

    secrets:
      QLTY_COVERAGE_TOKEN:
        description: 'Qlty Cloud coverage upload token'
        required: false

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  check-configuration:
    name: Check Qlty Configuration
    runs-on: ubuntu-latest
    outputs:
      has-token: ${{ steps.check.outputs.has-token }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Check for QLTY_COVERAGE_TOKEN
        id: check
        env:
          HAS_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN != '' }}
        run: |
          if [ "$HAS_TOKEN" = "true" ]; then
            echo "has-token=true" >> $GITHUB_OUTPUT
            echo "::notice::QLTY_COVERAGE_TOKEN is configured. Coverage upload will proceed."
          else
            echo "has-token=false" >> $GITHUB_OUTPUT

            if [ "${{ inputs.skip-if-no-token }}" = "true" ]; then
              echo "::warning::QLTY_COVERAGE_TOKEN is not configured. Skipping coverage upload."
              echo ""
              echo "To enable Qlty coverage tracking:"
              echo "1. Sign up at https://qlty.sh"
              echo "2. Connect your GitHub organization"
              echo "3. Generate a coverage token at https://qlty.sh/settings/tokens"
              echo "4. Add QLTY_COVERAGE_TOKEN as a repository secret"
            else
              echo "::error::QLTY_COVERAGE_TOKEN is required but not configured."
              exit 1
            fi
          fi

  upload-coverage:
    name: Upload Coverage to Qlty
    runs-on: ubuntu-latest
    needs: check-configuration
    if: needs.check-configuration.outputs.has-token == 'true'
    timeout-minutes: ${{ inputs.timeout-minutes }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e  # v2.10.4
        with:
          egress-policy: audit

      - name: Download Coverage Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: ${{ inputs.coverage-artifact-name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.workflow-run-id != '' && inputs.workflow-run-id || github.run_id }}

      - name: Verify Coverage Files
        id: verify
        run: |
          echo "ðŸ“Š Verifying coverage files..."
          PRIMARY_FILE="${{ inputs.coverage-file-path }}"

          if [ -f "$PRIMARY_FILE" ]; then
            echo "âœ… Primary coverage file found: $PRIMARY_FILE"
            echo "primary_exists=true" >> $GITHUB_OUTPUT
            ls -lh "$PRIMARY_FILE"

            # Show file preview
            echo ""
            echo "File preview (first 10 lines):"
            head -10 "$PRIMARY_FILE" || true
          else
            echo "âŒ Primary coverage file not found: $PRIMARY_FILE"
            echo "primary_exists=false" >> $GITHUB_OUTPUT

            echo ""
            echo "Available files in artifact:"
            find . -type f -name "*.info" -o -name "*.xml" -o -name "coverage.*" || true
          fi

          # Check additional files if specified
          if [ -n "${{ inputs.additional-files }}" ]; then
            echo ""
            echo "Checking additional coverage files..."
            IFS=',' read -ra FILES <<< "${{ inputs.additional-files }}"
            ADDITIONAL_COUNT=0
            for file in "${FILES[@]}"; do
              file=$(echo "$file" | xargs)  # Trim whitespace
              if [ -f "$file" ]; then
                echo "  âœ… $file"
                ADDITIONAL_COUNT=$((ADDITIONAL_COUNT + 1))
              else
                echo "  âš ï¸  $file (not found)"
              fi
            done
            echo "additional_count=$ADDITIONAL_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Qlty
        if: steps.verify.outputs.primary_exists == 'true'
        uses: qltysh/qlty-action/coverage@5ae0d52aa70ca423aa85f3cea4db51f6a8b46e90  # v2.0.0
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: ${{ inputs.coverage-file-path }}${{ inputs.additional-files != '' && format(',{0}', inputs.additional-files) || '' }}
        continue-on-error: ${{ !inputs.fail-on-upload-error }}

      - name: Coverage Upload Summary
        if: always()
        run: |
          echo "# ðŸ“Š Qlty Coverage Upload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.primary_exists }}" = "true" ]; then
            echo "## âœ… Coverage Uploaded Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Files Uploaded:**" >> $GITHUB_STEP_SUMMARY
            echo "- Primary: \`${{ inputs.coverage-file-path }}\`" >> $GITHUB_STEP_SUMMARY

            if [ -n "${{ inputs.additional-files }}" ]; then
              echo "- Additional: ${{ steps.verify.outputs.additional_count }} file(s)" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View coverage trends at: [Qlty Dashboard](https://qlty.sh/orgs/${{ github.repository_owner }}/repos/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Coverage Upload Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Coverage file not found: \`${{ inputs.coverage-file-path }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
            echo "- Test suite did not run or failed" >> $GITHUB_STEP_SUMMARY
            echo "- Coverage artifact name mismatch" >> $GITHUB_STEP_SUMMARY
            echo "- Coverage file path incorrect" >> $GITHUB_STEP_SUMMARY
            echo "- Workflow run ID incorrect (workflow_run trigger)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on Upload Error
        if: inputs.fail-on-upload-error && steps.verify.outputs.primary_exists != 'true'
        run: |
          echo "::error::Coverage file not found: ${{ inputs.coverage-file-path }}"
          exit 1
